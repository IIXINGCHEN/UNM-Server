# UNM-Server V2 生产环境部署检查清单

## 🔍 部署前检查清单

### 📋 环境配置检查
- [ ] **环境变量配置完整**
  - [ ] `NODE_ENV=production` 已设置
  - [ ] `DATABASE_URL` 已配置真实的生产数据库
  - [ ] `REDIS_URL` 已配置真实的Redis服务
  - [ ] `JWT_SECRET` 已设置强密钥（至少32字符）
  - [ ] `ALLOWED_DOMAIN` 已设置具体域名（禁止使用 `*`）

- [ ] **敏感信息安全**
  - [ ] 所有密码和密钥已通过安全方式设置（环境变量/密钥管理服务）
  - [ ] Cookie 和 API 密钥已配置（如需要）
  - [ ] 配置文件中无硬编码敏感信息

### 🔒 安全配置检查
- [ ] **CORS 配置**
  - [ ] 生产环境禁用通配符 `*`
  - [ ] 仅允许必要的域名访问
  - [ ] 正确配置 `credentials` 选项

- [ ] **安全头部**
  - [ ] CSP (Content Security Policy) 已启用
  - [ ] HSTS 已配置（HTTPS 环境）
  - [ ] XSS 保护已启用
  - [ ] 安全相关头部完整

- [ ] **速率限制**
  - [ ] 全局速率限制已启用
  - [ ] API 特定速率限制已配置
  - [ ] Redis 分布式限制器工作正常

### 🗄️ 数据库和缓存检查
- [ ] **数据库配置**
  - [ ] 生产数据库连接正常
  - [ ] 连接池配置合理
  - [ ] 数据库迁移已执行
  - [ ] 备份策略已配置

- [ ] **缓存配置**
  - [ ] Redis 服务运行正常
  - [ ] 缓存降级机制工作
  - [ ] TTL 配置合理

### 🚀 部署配置检查
- [ ] **Vercel 部署**
  - [ ] `vercel.json` 配置正确
  - [ ] 环境变量已在 Vercel Dashboard 设置
  - [ ] 构建命令正确
  - [ ] 函数超时配置合理

- [ ] **Netlify 部署**
  - [ ] `netlify.toml` 配置正确
  - [ ] 环境变量已在 Netlify Dashboard 设置
  - [ ] 函数配置正确
  - [ ] 重定向规则正确

### 📊 监控和日志检查
- [ ] **健康检查**
  - [ ] `/health` 端点响应正常
  - [ ] 健康检查包含必要信息
  - [ ] 监控系统已配置

- [ ] **日志配置**
  - [ ] 日志级别设置为 `info` 或 `warn`
  - [ ] 日志格式为 JSON（便于分析）
  - [ ] 敏感信息已脱敏

### 🔧 性能优化检查
- [ ] **缓存策略**
  - [ ] HTTP 缓存头配置正确
  - [ ] 静态资源缓存启用
  - [ ] API 响应缓存合理

- [ ] **压缩和优化**
  - [ ] Gzip 压缩已启用
  - [ ] 请求体大小限制合理
  - [ ] 连接超时配置合理

## 🧪 部署后验证清单

### 🔍 功能验证
- [ ] **API 端点测试**
  - [ ] `GET /health` 返回正常状态
  - [ ] `GET /api` 返回 API 信息
  - [ ] `GET /api/info` 返回详细信息
  - [ ] 音乐 API 端点正常工作

- [ ] **错误处理测试**
  - [ ] 404 错误正确处理
  - [ ] 500 错误正确处理
  - [ ] 参数验证错误正确处理

### 🔒 安全验证
- [ ] **CORS 测试**
  - [ ] 允许的域名可以访问
  - [ ] 不允许的域名被拒绝
  - [ ] 预检请求正确处理

- [ ] **速率限制测试**
  - [ ] 超过限制时返回 429 错误
  - [ ] 速率限制头部正确设置
  - [ ] 重置时间正确

### 📊 性能验证
- [ ] **响应时间测试**
  - [ ] API 响应时间在可接受范围内
  - [ ] 缓存命中率合理
  - [ ] 数据库查询性能正常

- [ ] **负载测试**
  - [ ] 并发请求处理正常
  - [ ] 内存使用稳定
  - [ ] CPU 使用合理

## 🚨 故障排除指南

### 常见问题
1. **环境变量未生效**
   - 检查部署平台环境变量设置
   - 确认变量名称拼写正确
   - 重新部署应用

2. **数据库连接失败**
   - 检查 `DATABASE_URL` 格式
   - 确认数据库服务运行状态
   - 检查网络连接和防火墙

3. **Redis 连接失败**
   - 检查 `REDIS_URL` 配置
   - 确认 Redis 服务状态
   - 验证认证信息

4. **CORS 错误**
   - 检查 `ALLOWED_DOMAIN` 配置
   - 确认请求来源域名
   - 验证预检请求处理

### 监控指标
- **响应时间**: < 500ms (P95)
- **错误率**: < 1%
- **可用性**: > 99.9%
- **内存使用**: < 80%
- **CPU 使用**: < 70%

## 📞 紧急联系方式
- **技术负责人**: [联系方式]
- **运维团队**: [联系方式]
- **监控告警**: [告警渠道]

## 📚 相关文档
- [部署指南](./DEPLOYMENT.md)
- [安全配置](./SECURITY_CONFIG.md)
- [API 文档](./README.md)
- [故障排除](./TROUBLESHOOTING.md)
